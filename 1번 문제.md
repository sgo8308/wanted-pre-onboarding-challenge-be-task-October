# 동시에 같은 DB Table row 를 업데이트 하는 상황을 방어하기 위해 어떻게 개발하실 건지 설명해주세요.

서버가 1대라면 Java의 Synchronized처럼 DB Table row에 update하는 메소드에 락을 걸어서 해결할 수 있다.

서버가 2대 이상이라면 다음 방식을 고려할 수 있다.

- 비관적인 락

비관적인 락의 경우 Select for update를 이용해 update를 위한 select라는 의도를 명시함으로써 다른 세션이 같은 row에 업데이트를 위해 접근하는 것을 막는다. 이처럼 락이 적용되어 여러 세션이 순차적으로 row를 업데이트하게 되어 문제를 해결할 수 있다.

- 낙관적인 락

낙관적인 락의 경우 처음 select했을 때의 row와 동일한 version의 row로 값을 집어넣는다. 만약 다른 세션이 그 사이에 row를 업데이트해서 version이 달라져서 값을 업데이트하는데 실패할 경우 update를 재시도하는 방식으로 구현할 수 있다. 이 경우 동시 업데이트하는 상황에서 약간이라도 늦은 쪽은 update 실패가 일어나고 재시도하게 됨으로써 문제를 해결할 수 있다.

- 분산 락

Redis를 추가적으로 사용한다. 각 서버의 update 메소드는 먼저 Redis에 key를 얻어야만 update를 진행할 수 있게 한다. Redis는 싱글쓰레드이기 때문에 동시에 요청이 도착해도 먼저 도착한 하나만 key를 얻을 수 있고 나머지는 기다려야 한다. key를 얻은 쪽은 update하고자 하는 row 값을 가져와서 업데이트를 진행하고 key를 반납한다. 그리고 그 다음 요청이 update를 진행한다.
이런 식으로 DB 바깥에서 잠금을 얻어 문제를 해결할 수 있다.

- 결론

비관적인 락의 경우 동시 업데이트가 문제가 정말 많이 일어나는 환경에서 사용한다. 매번 락을 거는 비용이 업데이트에 실패하고 다시 쿼리하는 비용보다 낮기 때문이다.
낙관적인 락의 경우 동시 업데이트 문제가 작게 일어나는 환경에서 사용한다.
분산 락의 경우 위 2 방식을 사용하기 어려운 상황에서 사용한다.
Redis를 추가적으로 구성하고, 매 update마다 Redis에 접근해야 하는 비용과 비관적인 락이 갖고 있는 단점을 함께 갖고 있기 때문이다.



